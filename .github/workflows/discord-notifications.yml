# ===========================================
# ASTRA BOT - Discord Notifications
# ===========================================
# Sends Discord webhook notifications for GitHub events.
#
# Required Secrets:
#   DISCORD_WEBHOOK_URL - Your Discord webhook URL
#   DISCORD_WEBHOOK_URL_RELEASES (optional) - Separate webhook for releases
#
# Features:
#   - Push notifications with commit details
#   - Pull Request status updates
#   - Issue tracking notifications
#   - Release announcements
#   - CI/CD failure reports
#   - Star/Fork milestones

name: Discord Notifications

on:
  push:
    branches: [main, develop]
  
  pull_request:
    types: [opened, closed, reopened, ready_for_review]
  
  issues:
    types: [opened, closed, reopened]
  
  release:
    types: [published, prereleased]
  
  workflow_run:
    workflows: ["CI"]
    types: [completed]
  
  watch:
    types: [started]
  
  fork:

env:
  BOT_NAME: Astra Bot
  BOT_ICON: https://raw.githubusercontent.com/XSaitoKungX/Astra-Bot/main/dashboard/public/android-chrome-192x192.png

jobs:
  # ============================================
  # PUSH NOTIFICATIONS
  # ============================================
  push-notification:
    name: Push Notification
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Send Push Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          COMMITS_JSON: ${{ toJson(github.event.commits) }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ö†Ô∏è DISCORD_WEBHOOK_URL secret not set, skipping"
            exit 0
          fi
          
          BRANCH="${GITHUB_REF#refs/heads/}"
          
          if [ "$BRANCH" = "main" ]; then
            COLOR=5763719
            EMOJI="üöÄ"
          else
            COLOR=5793266
            EMOJI="üîß"
          fi
          
          COMMIT_COUNT=$(echo "$COMMITS_JSON" | jq 'length')
          
          # Build commit list
          COMMITS=""
          COUNT=0
          while IFS= read -r line; do
            if [ $COUNT -ge 5 ]; then
              COMMITS="${COMMITS}... and more\\n"
              break
            fi
            SHA=$(echo "$line" | jq -r '.id' | cut -c1-7)
            MSG=$(echo "$line" | jq -r '.message' | head -1 | cut -c1-50)
            COMMITS="${COMMITS}[\`${SHA}\`](${{ github.event.repository.html_url }}/commit/$(echo "$line" | jq -r '.id')) ${MSG}\\n"
            COUNT=$((COUNT + 1))
          done < <(echo "$COMMITS_JSON" | jq -c '.[]')
          
          # Build payload using jq for proper escaping
          PAYLOAD=$(jq -n \
            --arg title "${EMOJI} ${COMMIT_COUNT} commit(s) pushed to ${BRANCH}" \
            --arg desc "$COMMITS" \
            --arg url "${{ github.event.compare }}" \
            --argjson color "$COLOR" \
            --arg author "${{ github.event.pusher.name }}" \
            --arg author_icon "${{ github.event.sender.avatar_url }}" \
            --arg footer "$BOT_NAME ‚Ä¢ GitHub" \
            --arg footer_icon "$BOT_ICON" \
            '{
              embeds: [{
                title: $title,
                description: $desc,
                url: $url,
                color: $color,
                author: { name: $author, icon_url: $author_icon },
                footer: { text: $footer, icon_url: $footer_icon },
                timestamp: (now | todate)
              }]
            }')
          
          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"

  # ============================================
  # PULL REQUEST NOTIFICATIONS
  # ============================================
  pr-notification:
    name: PR Notification
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Send PR Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ö†Ô∏è DISCORD_WEBHOOK_URL secret not set, skipping"
            exit 0
          fi
          
          ACTION="${{ github.event.action }}"
          MERGED="${{ github.event.pull_request.merged }}"
          
          case "$ACTION" in
            "opened")
              TITLE="üì¨ New Pull Request"
              COLOR=5793266
              ;;
            "closed")
              if [ "$MERGED" = "true" ]; then
                TITLE="üéâ Pull Request Merged"
                COLOR=5763719
              else
                TITLE="‚ùå Pull Request Closed"
                COLOR=15548997
              fi
              ;;
            "reopened")
              TITLE="üîÑ Pull Request Reopened"
              COLOR=16705372
              ;;
            "ready_for_review")
              TITLE="üëÄ PR Ready for Review"
              COLOR=5793266
              ;;
            *)
              TITLE="üìù Pull Request Update"
              COLOR=5793266
              ;;
          esac
          
          DESC="${PR_BODY:-No description provided.}"
          DESC=$(echo "$DESC" | head -c 200)
          
          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg pr_title "$PR_TITLE" \
            --arg pr_num "#${{ github.event.pull_request.number }}" \
            --arg pr_url "${{ github.event.pull_request.html_url }}" \
            --arg desc "$DESC" \
            --argjson color "$COLOR" \
            --arg changes "+${{ github.event.pull_request.additions }} / -${{ github.event.pull_request.deletions }}" \
            --arg files "${{ github.event.pull_request.changed_files }}" \
            --arg target "${{ github.event.pull_request.base.ref }}" \
            --arg author "${{ github.event.pull_request.user.login }}" \
            --arg author_icon "${{ github.event.pull_request.user.avatar_url }}" \
            --arg footer "$BOT_NAME ‚Ä¢ GitHub" \
            --arg footer_icon "$BOT_ICON" \
            '{
              embeds: [{
                title: $title,
                description: "**[\($pr_num)](\($pr_url)) \($pr_title)**\n\n\($desc)",
                url: $pr_url,
                color: $color,
                fields: [
                  { name: "üìä Changes", value: $changes, inline: true },
                  { name: "üìÅ Files", value: $files, inline: true },
                  { name: "üéØ Target", value: "`\($target)`", inline: true }
                ],
                author: { name: $author, icon_url: $author_icon },
                footer: { text: $footer, icon_url: $footer_icon },
                timestamp: (now | todate)
              }]
            }')
          
          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"

  # ============================================
  # ISSUE NOTIFICATIONS
  # ============================================
  issue-notification:
    name: Issue Notification
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    
    steps:
      - name: Send Issue Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          LABELS_JSON: ${{ toJson(github.event.issue.labels) }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ö†Ô∏è DISCORD_WEBHOOK_URL secret not set, skipping"
            exit 0
          fi
          
          ACTION="${{ github.event.action }}"
          
          case "$ACTION" in
            "opened")
              TITLE="üêõ New Issue"
              COLOR=16705372
              ;;
            "closed")
              TITLE="‚úÖ Issue Closed"
              COLOR=5763719
              ;;
            "reopened")
              TITLE="üîÑ Issue Reopened"
              COLOR=16705372
              ;;
            *)
              exit 0
              ;;
          esac
          
          # Format labels with emojis
          LABELS=""
          while IFS= read -r label; do
            [ -z "$label" ] && continue
            case "$label" in
              bug) LABELS="${LABELS}üêõ Bug  " ;;
              enhancement) LABELS="${LABELS}‚ú® Enhancement  " ;;
              feature) LABELS="${LABELS}üöÄ Feature  " ;;
              documentation) LABELS="${LABELS}üìö Docs  " ;;
              help*) LABELS="${LABELS}‚ùì Help  " ;;
              good*) LABELS="${LABELS}üëç Good First  " ;;
              priority:*) 
                prio="${label#priority: }"
                case "$prio" in
                  high|critical) LABELS="${LABELS}üî¥ $prio  " ;;
                  medium) LABELS="${LABELS}üü° $prio  " ;;
                  low) LABELS="${LABELS}üü¢ $prio  " ;;
                  *) LABELS="${LABELS}‚ö™ $prio  " ;;
                esac
                ;;
              type:*) LABELS="${LABELS}üìã ${label#type: }  " ;;
              area:*) LABELS="${LABELS}üìÅ ${label#area: }  " ;;
              *) LABELS="${LABELS}üè∑Ô∏è $label  " ;;
            esac
          done < <(echo "$LABELS_JSON" | jq -r '.[].name')
          
          [ -z "$LABELS" ] && LABELS="None"
          
          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg issue_title "$ISSUE_TITLE" \
            --arg issue_num "#${{ github.event.issue.number }}" \
            --arg issue_url "${{ github.event.issue.html_url }}" \
            --argjson color "$COLOR" \
            --arg labels "$LABELS" \
            --arg author "${{ github.event.issue.user.login }}" \
            --arg author_icon "${{ github.event.issue.user.avatar_url }}" \
            --arg footer "$BOT_NAME ‚Ä¢ GitHub" \
            --arg footer_icon "$BOT_ICON" \
            '{
              embeds: [{
                title: $title,
                description: "**[\($issue_num)](\($issue_url)) \($issue_title)**",
                url: $issue_url,
                color: $color,
                fields: [
                  { name: "Labels", value: $labels, inline: false }
                ],
                author: { name: $author, icon_url: $author_icon },
                footer: { text: $footer, icon_url: $footer_icon },
                timestamp: (now | todate)
              }]
            }')
          
          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"

  # ============================================
  # RELEASE NOTIFICATIONS
  # ============================================
  release-notification:
    name: Release Notification
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
      - name: Send Release Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL_RELEASES || secrets.DISCORD_WEBHOOK_URL }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ö†Ô∏è No webhook configured, skipping"
            exit 0
          fi
          
          PRERELEASE="${{ github.event.release.prerelease }}"
          
          if [ "$PRERELEASE" = "true" ]; then
            TITLE="üß™ Pre-Release Published"
            COLOR=16705372
            TYPE="Pre-Release"
          else
            TITLE="üéâ New Release Published!"
            COLOR=5763719
            TYPE="Stable Release"
          fi
          
          BODY="${RELEASE_BODY:-Check the release page for details.}"
          BODY=$(echo "$BODY" | head -c 400)
          
          PAYLOAD=$(jq -n \
            --arg content "üöÄ **New $BOT_NAME Release!**" \
            --arg title "$TITLE" \
            --arg name "$RELEASE_NAME" \
            --arg body "$BODY" \
            --arg url "${{ github.event.release.html_url }}" \
            --argjson color "$COLOR" \
            --arg tag "${{ github.event.release.tag_name }}" \
            --arg type "$TYPE" \
            --arg author "${{ github.event.release.author.login }}" \
            --arg author_icon "${{ github.event.release.author.avatar_url }}" \
            --arg thumbnail "$BOT_ICON" \
            --arg footer "$BOT_NAME ‚Ä¢ GitHub Releases" \
            --arg footer_icon "$BOT_ICON" \
            '{
              content: $content,
              embeds: [{
                title: $title,
                description: "**\($name)**\n\n\($body)",
                url: $url,
                color: $color,
                fields: [
                  { name: "üì¶ Version", value: "`\($tag)`", inline: true },
                  { name: "üìã Type", value: $type, inline: true },
                  { name: "üì• Download", value: "[View Release](\($url))", inline: true }
                ],
                author: { name: $author, icon_url: $author_icon },
                thumbnail: { url: $thumbnail },
                footer: { text: $footer, icon_url: $footer_icon },
                timestamp: (now | todate)
              }]
            }')
          
          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"

  # ============================================
  # CI FAILURE NOTIFICATIONS
  # ============================================
  ci-failure-notification:
    name: CI Failure Notification
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure'
    
    steps:
      - name: Send CI Failure Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            exit 0
          fi
          
          PAYLOAD=$(jq -n \
            --arg workflow "${{ github.event.workflow_run.name }}" \
            --arg branch "${{ github.event.workflow_run.head_branch }}" \
            --arg sha "${{ github.event.workflow_run.head_sha }}" \
            --arg sha_short "$(echo '${{ github.event.workflow_run.head_sha }}' | cut -c1-7)" \
            --arg url "${{ github.event.workflow_run.html_url }}" \
            --arg repo_url "${{ github.event.repository.html_url }}" \
            --arg run_num "#${{ github.event.workflow_run.run_number }}" \
            --arg event "${{ github.event.workflow_run.event }}" \
            --arg author "${{ github.event.workflow_run.actor.login }}" \
            --arg author_icon "${{ github.event.workflow_run.actor.avatar_url }}" \
            --arg footer "$BOT_NAME ‚Ä¢ GitHub Actions" \
            --arg footer_icon "$BOT_ICON" \
            '{
              embeds: [{
                title: "‚ùå CI Pipeline Failed",
                description: "**Workflow:** \($workflow)\n**Branch:** `\($branch)`\n**Commit:** [`\($sha_short)`](\($repo_url)/commit/\($sha))",
                url: $url,
                color: 15548997,
                fields: [
                  { name: "üîÑ Run", value: $run_num, inline: true },
                  { name: "üìã Event", value: $event, inline: true }
                ],
                author: { name: $author, icon_url: $author_icon },
                footer: { text: $footer, icon_url: $footer_icon },
                timestamp: (now | todate)
              }]
            }')
          
          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"

  # ============================================
  # STAR MILESTONE NOTIFICATIONS
  # ============================================
  star-milestone:
    name: Star Milestone
    runs-on: ubuntu-latest
    if: github.event_name == 'watch'
    
    steps:
      - name: Check and Send Milestone
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            exit 0
          fi
          
          STARS=${{ github.event.repository.stargazers_count }}
          
          NOTIFY=false
          if [ $((STARS % 100)) -eq 0 ] && [ $STARS -gt 0 ]; then
            NOTIFY=true
            MSG="üåü **${STARS} Stars!** Thank you for the amazing support!"
          elif [ $((STARS % 50)) -eq 0 ] && [ $STARS -gt 0 ]; then
            NOTIFY=true
            MSG="‚≠ê **${STARS} Stars!** We're growing!"
          elif [ $((STARS % 25)) -eq 0 ] && [ $STARS -gt 0 ]; then
            NOTIFY=true
            MSG="‚ú® **${STARS} Stars!** Thanks for the support!"
          fi
          
          if [ "$NOTIFY" = "false" ]; then
            echo "Not a milestone ($STARS stars), skipping"
            exit 0
          fi
          
          PAYLOAD=$(jq -n \
            --arg msg "$MSG" \
            --arg url "${{ github.event.repository.html_url }}" \
            --argjson stars "$STARS" \
            --arg forks "${{ github.event.repository.forks_count }}" \
            --arg watchers "${{ github.event.repository.subscribers_count }}" \
            --arg thumbnail "$BOT_ICON" \
            --arg footer "$BOT_NAME ‚Ä¢ GitHub" \
            --arg footer_icon "$BOT_ICON" \
            '{
              embeds: [{
                title: "‚≠ê Star Milestone Reached!",
                description: $msg,
                url: $url,
                color: 16766720,
                fields: [
                  { name: "üåü Stars", value: ($stars | tostring), inline: true },
                  { name: "üç¥ Forks", value: $forks, inline: true },
                  { name: "üëÄ Watchers", value: $watchers, inline: true }
                ],
                thumbnail: { url: $thumbnail },
                footer: { text: $footer, icon_url: $footer_icon }
              }]
            }')
          
          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"

  # ============================================
  # FORK MILESTONE NOTIFICATIONS
  # ============================================
  fork-milestone:
    name: Fork Milestone
    runs-on: ubuntu-latest
    if: github.event_name == 'fork'
    
    steps:
      - name: Check and Send Fork Milestone
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            exit 0
          fi
          
          FORKS=${{ github.event.repository.forks_count }}
          
          if [ $((FORKS % 25)) -ne 0 ] || [ $FORKS -eq 0 ]; then
            echo "Not a fork milestone ($FORKS forks), skipping"
            exit 0
          fi
          
          PAYLOAD=$(jq -n \
            --argjson forks "$FORKS" \
            --arg forker "${{ github.event.forkee.owner.login }}" \
            --arg fork_url "${{ github.event.forkee.html_url }}" \
            --arg repo_url "${{ github.event.repository.html_url }}" \
            --arg forker_icon "${{ github.event.forkee.owner.avatar_url }}" \
            --arg footer "$BOT_NAME ‚Ä¢ GitHub" \
            --arg footer_icon "$BOT_ICON" \
            '{
              embeds: [{
                title: "üç¥ Fork Milestone!",
                description: "**\($forks)** forks reached!\n\nForked by [\($forker)](\($fork_url))",
                url: $repo_url,
                color: 5793266,
                author: { name: $forker, icon_url: $forker_icon },
                footer: { text: $footer, icon_url: $footer_icon }
              }]
            }')
          
          curl -s -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK"
